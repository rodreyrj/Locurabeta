<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Versat Lite Pro - Control Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background:#f8fafc; color:#0f172a; overflow-x:hidden; }
        .sidebar-item.active { background:#1e293b; color:#f8fafc; border-right:4px solid #3b82f6; }
        .view-section { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }
        #toast-container { position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px; }

        /* Overlay forcing upload of local file */
        #uploadOverlay {
          position: fixed;
          inset: 0;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(2,6,23,0.65);
          z-index: 150000;
        }
        #uploadCard {
          background: white;
          width: 94%;
          max-width: 640px;
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 10px 30px rgba(2,6,23,0.45);
          text-align: left;
        }
        #uploadMsg { color:#dc2626; font-size:13px; min-height:18px; text-align:center; margin-top:10px; }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">

  <div id="toast-container"></div>

  <!-- UPLOAD OVERLAY: visible until user uploads a valid JSON with single email -->
  <div id="uploadOverlay" role="dialog" aria-modal="true">
    <div id="uploadCard">
      <h2 class="text-2xl font-extrabold text-center mb-2">Subir archivo del vendedor (aut.json)</h2>
      <p class="text-sm text-slate-600 text-center mb-4">
        Selecciona el archivo .json que te dio el vendedor. El archivo debe contener exactamente UN usuario (un solo correo).
        Ejemplo m√≠nimo: <code>{ "id":"U1", "email":"vendedor@ejemplo.com", "name":"Vendedor" }</code>
        Al seleccionar el archivo se guardar√° su contenido en localStorage (clave "aut.json") y la sesi√≥n se activar√° (clave "vp_user_email").
      </p>

      <div class="flex items-center justify-center gap-3">
        <input id="uploadInput" type="file" accept=".json,application/json" class="hidden" />
        <label for="uploadInput" class="cursor-pointer bg-slate-900 text-white px-5 py-2 rounded font-bold">Seleccionar archivo .json</label>
        <button id="uploadSkip" class="bg-slate-100 px-4 py-2 rounded">Cancelar (abrir demo)</button>
      </div>

      <p id="uploadMsg" aria-atomic="true"></p>
    </div>
  </div>

  <!-- SIDEBAR PC -->
  <aside class="no-print hidden md:flex flex-col w-64 bg-slate-900 text-slate-300 h-screen sticky top-0 shadow-2xl">
    <div class="p-6">
      <h1 class="text-xl font-extrabold text-white flex items-center gap-2 italic"><span class="bg-blue-600 p-1.5 rounded text-sm">V</span> Versat Pro</h1>
      <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Sistemas Contables</p>
    </div>
    <nav class="flex-1 px-3 space-y-1">
      <button onclick="navTo('dashboard')" id="pc-btn-dashboard" class="sidebar-item active w-full text-left px-4 py-3 rounded-xl font-semibold">Caja Diaria</button>
      <button onclick="navTo('reports')" id="pc-btn-reports" class="sidebar-item w-full text-left px-4 py-3 rounded-xl font-semibold hover:bg-slate-800">Balance y Reportes</button>
      <button onclick="navTo('config')" id="pc-btn-config" class="sidebar-item w-full text-left px-4 py-3 rounded-xl font-semibold hover:bg-slate-800">Ajustes de Caja</button>
      <button onclick="navTo('backup')" id="pc-btn-backup" class="sidebar-item w-full text-left px-4 py-3 rounded-xl font-semibold hover:bg-slate-800">Importar/Exportar</button>
    </nav>
  </aside>

  <!-- MOBILE HEADER -->
  <nav class="md:hidden bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center no-print shadow-lg">
    <h1 class="font-bold flex items-center gap-2 text-sm"><span class="bg-blue-600 px-1.5 rounded">V</span> Versat Pro</h1>
    <div class="flex flex-col items-end">
      <span class="text-[9px] uppercase font-black text-slate-500 tracking-tighter">Efectivo Total</span>
      <div id="mob-saldo" class="text-sm font-black text-green-400 leading-none">$0</div>
    </div>
  </nav>

  <!-- MAIN APP (original UI kept intact) -->
  <main class="flex-1 flex flex-col min-h-screen no-print pb-24 md:pb-0">
    <section class="p-4 md:p-8 flex-1 max-w-6xl mx-auto w-full">
      <!-- Full original HTML content (dashboard / views) - kept as you provided -->
      <!-- DASHBOARD -->
      <div id="view-dashboard" class="view-section">
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
          <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-200 col-span-2 md:col-span-1 flex flex-col justify-center">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Efectivo en Caja</p>
            <h2 id="saldo-box" class="text-3xl font-black text-slate-900 leading-none tracking-tight">$0</h2>
          </div>
          <div class="bg-green-50 p-5 rounded-[2rem] border border-green-100">
            <p class="text-[10px] font-bold text-green-600 uppercase tracking-widest mb-1">Ingresos Hoy</p>
            <h2 id="ingresos-hoy" class="text-xl font-black text-green-700">$0</h2>
          </div>
          <div class="bg-red-50 p-5 rounded-[2rem] border border-red-100">
            <p class="text-[10px] font-bold text-red-600 uppercase tracking-widest mb-1">Gastos Hoy</p>
            <h2 id="gastos-hoy" class="text-xl font-black text-red-700">$0</h2>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          <div class="lg:col-span-5">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-200">
              <h3 class="font-black text-slate-800 mb-6 flex justify-between items-center text-xs uppercase tracking-tight">
                Nueva Operaci√≥n
                <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-[9px] font-bold">CAJA ABIERTA</span>
              </h3>
              <div class="space-y-4">
                <div>
                  <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 block">Categor√≠a</label>
                  <select id="main-cat" onchange="updateButtons()" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold text-slate-700 shadow-inner cursor-pointer">
                    <option value="Ventas">üí∞ Venta de Producto (+)</option>
                    <option value="Servicios">üõ†Ô∏è Servicio T√©cnico (+)</option>
                    <option value="Gastos">üõí Gasto de Local (-)</option>
                    <option value="Salarios">üë§ Pago de Personal (-)</option>
                    <option value="Suministros">üì¶ Compra Insumos (-)</option>
                  </select>
                </div>
                <div>
                  <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 block">Descripci√≥n</label>
                  <input type="text" id="desc" placeholder="¬øQu√© se cobr√≥ o pag√≥?" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 shadow-inner">
                </div>
                <div>
                  <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 mb-1 block">Monto (CUP)</label>
                  <input type="number" id="monto" placeholder="0" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-black text-2xl shadow-inner" inputmode="decimal">
                </div>
                <div id="btn-container" class="pt-2"></div>
              </div>
            </div>
          </div>

          <div class="lg:col-span-7">
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200">
              <div class="flex justify-between items-center mb-6">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Movimientos de Hoy</h3>
                <button onclick="txs = txs.filter(t => t.date !== new Date().toLocaleDateString('es-CU')); localStorage.setItem('versat_pro_txs', JSON.stringify(txs)); renderDashboard();" class="text-[10px] font-bold text-red-400 hover:text-red-600 uppercase tracking-tighter">Limpiar</button>
              </div>
              <div id="tx-list" class="space-y-3 max-h-[500px] overflow-y-auto pr-2"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- other original views kept unchanged -->
    </section>
  </main>

  <!-- PRINT AREA (kept) -->
  <div class="print-only p-8 text-slate-900 bg-white" id="invoice-print"></div>

  <!-- ORIGINAL APP SCRIPT (kept) -->
  <script>
    // app state/functions (kept minimal but compatible with the UI above)
    let txs = JSON.parse(localStorage.getItem('versat_pro_txs')) || [];
    let config = JSON.parse(localStorage.getItem('versat_pro_config')) || { initialBalance: 0 };

    function showToast(type, message) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'error' ? 'bg-red-600 text-white' : 'bg-blue-600 text-white';
      toast.innerHTML = `<div class="${bgColor} px-4 py-2 rounded shadow">${message}</div>`;
      container.appendChild(toast);
      setTimeout(()=>toast.remove(), 2800);
    }

    function navTo(view) {
      document.querySelectorAll('.view-section').forEach(s => s.classList.add('hidden'));
      const t = document.getElementById('view-' + view);
      if (t) t.classList.remove('hidden');
      document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
      const pc = document.getElementById('pc-btn-' + view);
      if (pc) pc.classList.add('active');
      if (view === 'reports') renderReports();
      if (view === 'config') renderConfigView();
    }

    function updateButtons() {
      const catEl = document.getElementById('main-cat');
      if (!catEl) return;
      const cat = catEl.value;
      const container = document.getElementById('btn-container');
      const isIncome = ['Ventas','Servicios'].includes(cat);
      const cls = isIncome ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-900 hover:bg-black';
      if (container) container.innerHTML = `<button onclick="save('${isIncome ? 'ingreso' : 'gasto'}')" class="w-full ${cls} text-white py-4 rounded-2xl font-bold">GUARDAR ${cat}</button>`;
    }

    function save(type) {
      const desc = (document.getElementById('desc')||{}).value || '';
      const monto = parseFloat((document.getElementById('monto')||{}).value || '0');
      const cat = (document.getElementById('main-cat')||{}).value || 'Ventas';
      if(!desc || isNaN(monto) || monto <= 0) { showToast('error','Completa descripci√≥n y monto'); return; }
      if(type === 'gasto') {
        const actual = txs.reduce((a,b)=>a+b.val, config.initialBalance);
        if (monto > actual) { showToast('error','No hay dinero suficiente'); return; }
      }
      txs.unshift({ id: 'V'+Math.floor(Math.random()*99999), desc, cat, val: type==='gasto'?-monto:monto, time: new Date().toLocaleTimeString('es-CU',{hour:'2-digit',minute:'2-digit'}), date: new Date().toLocaleDateString('es-CU')});
      localStorage.setItem('versat_pro_txs', JSON.stringify(txs));
      (document.getElementById('desc')||{}).value=''; (document.getElementById('monto')||{}).value='';
      showToast('success','Operaci√≥n registrada');
      renderDashboard();
    }

    function renderDashboard() {
      const list = document.getElementById('tx-list');
      if (!list) return;
      const hoy = new Date().toLocaleDateString('es-CU');
      let ing = 0, gas = 0;
      const total = txs.reduce((a,b)=>a+b.val, config.initialBalance);
      list.innerHTML = '';
      txs.forEach(t => {
        if (t.date === hoy) {
          if (t.val>0) ing += t.val; else gas += Math.abs(t.val);
          const isPos = t.val > 0;
          const el = document.createElement('div');
          el.className = "flex flex-col sm:flex-row sm:items-center justify-between p-4 bg-white rounded-2xl border shadow-sm gap-4";
          el.innerHTML = `<div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex items-center justify-center font-black text-xs ${isPos?'bg-green-100 text-green-600':'bg-red-100 text-red-600'}">${t.cat[0]}</div><div><h4 class="font-bold text-slate-800 text-sm">${t.desc}</h4><p class="text-[9px] text-slate-400 uppercase">${t.cat} ‚Ä¢ ${t.time}</p></div></div><div class="flex items-center gap-2"><span class="${isPos?'text-green-600':'text-red-600'} font-black">${format(t.val)}</span></div>`;
          list.appendChild(el);
        }
      });
      if (!list.innerHTML) list.innerHTML = `<p class="text-center py-10 text-slate-300 uppercase italic">Sin actividad registrada hoy</p>`;
      const sb = document.getElementById('saldo-box'); if (sb) sb.innerText = format(total);
      const ms = document.getElementById('mob-saldo'); if (ms) ms.innerText = format(total);
      const ih = document.getElementById('ingresos-hoy'); if (ih) ih.innerText = format(ing);
      const gh = document.getElementById('gastos-hoy'); if (gh) gh.innerText = format(gas);
    }

    function format(n){ const absN = Math.abs(n); const val = Number.isInteger(absN)?absN:absN.toFixed(2); return `$${val}`; }
    function renderReports(){ /* kept as original if needed */ }
  </script>

  <!-- UPLOAD HANDLER: stores uploaded file content in localStorage under key "aut.json" and saves vp_user_email -->
  <script>
    (function(){
      const overlay = document.getElementById('uploadOverlay');
      const input = document.getElementById('uploadInput');
      const msg = document.getElementById('uploadMsg');
      const skipBtn = document.getElementById('uploadSkip');

      function toast(txt, type='info'){ try{ showToast(type==='error'?'error':'success', txt); }catch(e){ console.log(txt); } }

      function extractEmails(obj){
        const re = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}/gi;
        const found = new Set();
        const seen = new WeakSet();
        function walk(x){
          if (!x || typeof x === 'number' || typeof x === 'boolean') return;
          if (typeof x === 'string'){ const m = x.match(re); if(m) m.forEach(s=>found.add(s.toLowerCase())); return; }
          if (typeof x === 'object'){
            if (seen.has(x)) return;
            seen.add(x);
            if (Array.isArray(x)) x.forEach(walk); else Object.keys(x).forEach(k=>walk(x[k]));
          }
        }
        walk(obj);
        return Array.from(found);
      }

      function getEmailFromParsed(parsed){
        if (!parsed) return null;
        if (Array.isArray(parsed)){
          if (parsed.length === 1 && parsed[0] && typeof parsed[0] === 'object'){
            if (parsed[0].email) return parsed[0].email.toLowerCase();
            if (parsed[0].correo) return parsed[0].correo.toLowerCase();
            const e = extractEmails(parsed[0]); if (e.length===1) return e[0];
            return null;
          }
          const e = extractEmails(parsed); if (e.length===1) return e[0]; return null;
        } else if (typeof parsed === 'object'){
          if (parsed.email) return parsed.email.toLowerCase();
          if (parsed.correo) return parsed.correo.toLowerCase();
          if (parsed.user_email) return parsed.user_email.toLowerCase();
          const e = extractEmails(parsed); if (e.length===1) return e[0]; return null;
        }
        return null;
      }

      async function handleFile(file){
        msg.textContent = '';
        if (!file){ msg.textContent = 'No seleccion√≥ archivo.'; return; }
        if (file.size > 3_000_000){ msg.textContent = 'Archivo demasiado grande.'; return; }
        try {
          const text = await file.text();
          let parsed;
          try { parsed = JSON.parse(text); } catch(e){ msg.textContent = 'JSON inv√°lido.'; return; }

          const email = getEmailFromParsed(parsed);
          if (!email){ msg.textContent = 'No se encontr√≥ exactamente UN correo en el JSON. El archivo debe contener un solo usuario.'; return; }
          if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ msg.textContent = 'Correo detectado no v√°lido.'; return; }

          // Save full JSON text into localStorage under key "aut.json"
          try {
            localStorage.setItem('aut.json', text);
            localStorage.setItem('vp_user_email', email);
          } catch (e) {
            console.error('localStorage set failed', e);
            msg.textContent = 'No se pudo guardar en localStorage (espacio o modo privado).';
            return;
          }

          toast('Archivo aceptado y guardado en localStorage (aut.json). Abriendo sistema...');
          overlay.remove();

          // initialize app
          try { if (typeof updateButtons === 'function') updateButtons(); } catch(e){ console.warn(e); }
          try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){ console.warn(e); }
          try { if (typeof renderReports === 'function') renderReports(); } catch(e){}
        } catch (err) {
          console.error(err);
          msg.textContent = 'Error leyendo el archivo.';
        }
      }

      // allow skipping (for demo) - but we store no aut.json and do not set vp_user_email
      skipBtn.addEventListener('click', ()=> {
        msg.textContent = 'Operaci√≥n cancelada ‚Äî la app se abrir√° en modo demo (sin usuario guardado).';
        try { overlay.remove(); } catch(e){}
        toast('Abriendo aplicaci√≥n en modo demo');
        try { if (typeof updateButtons === 'function') updateButtons(); } catch(e){}
        try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
      });

      input.addEventListener('change', (e)=> {
        const f = e.target.files && e.target.files[0];
        handleFile(f);
      });

      // On load: if aut.json stored and vp_user_email exists -> hide overlay and init app
      window.addEventListener('DOMContentLoaded', ()=> {
        const storedEmail = (localStorage.getItem('vp_user_email') || '').toLowerCase();
        const storedJson = localStorage.getItem('aut.json');
        if (storedEmail && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(storedEmail) && storedJson) {
          try { overlay.remove(); } catch(e){}
          try { if (typeof updateButtons === 'function') updateButtons(); } catch(e){}
          try { if (typeof renderDashboard === 'function') renderDashboard(); } catch(e){}
        } else {
          // Show overlay (it is visible by default in DOM); nothing else to do.
        }
      });
    })();
  </script>
</body>
</html>
